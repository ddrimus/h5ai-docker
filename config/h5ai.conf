server {
    listen 80 default_server reuseport;
    listen [::]:80 default_server reuseport;
    server_name _;

    root /h5ai;
    index index.html index.htm index.php /_h5ai/public/index.php;

    # Rate limiting and connection limits
    limit_req zone=download_limit burst=20 nodelay;
    limit_conn conn_limit 10;

    # File download optimizations
    location ~* \.(zip|rar|7z|tar|gz|bz2|exe|dmg|iso|img|deb|rpm|apk)$ {
        # Enable efficient file serving
        sendfile on;
        sendfile_max_chunk 2m;
        tcp_nopush on;
        tcp_nodelay off;
        
        # Cache control for downloads
        expires 1h;
        add_header Cache-Control "public, immutable";
        
        # Enable range requests for resume capability
        add_header Accept-Ranges bytes;
        
        # Prevent hotlinking of large files (optional)
        # valid_referers none blocked server_names;
        # if ($invalid_referer) { return 403; }
    }

    # Optimize static assets (images, videos, docs)
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|mp4|avi|mkv|mov|pdf|doc|docx|xls|xlsx|ppt|pptx)$ {
        sendfile on;
        tcp_nopush on;
        expires 7d;
        add_header Cache-Control "public, immutable";
        add_header Accept-Ranges bytes;
        
        # Optional: Generate thumbnails on-the-fly for h5ai
        try_files $uri $uri/ =404;
    }

    # h5ai application
    location /_h5ai/ {
        root /usr/share/h5ai/;

        # Cache h5ai static assets
        location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }

        # PHP processing for h5ai
        location ~ [^/]\.php(/|$) {
            fastcgi_split_path_info ^(.+?\.php)(/.*)$;
            fastcgi_pass 127.0.0.1:9000;
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param SCRIPT_NAME $fastcgi_script_name;
            fastcgi_param HTTP_PROXY "";
            
            # FastCGI optimizations
            fastcgi_buffer_size 128k;
            fastcgi_buffers 256 16k;
            fastcgi_busy_buffers_size 256k;
            fastcgi_temp_file_write_size 256k;
            fastcgi_read_timeout 300;
            
            include fastcgi_params;
        }
    }

    # PHP processing for compatibility
    location ~ [^/]\.php(/|$) {
        fastcgi_split_path_info ^(.+?\.php)(/.*)$;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param SCRIPT_NAME $fastcgi_script_name;
        fastcgi_param HTTP_PROXY "";
        
        # FastCGI optimizations
        fastcgi_buffer_size 128k;
        fastcgi_buffers 256 16k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;
        fastcgi_read_timeout 300;
        
        include fastcgi_params;
    }

    # Security: deny access to sensitive files
    location ~ /\.ht {
        deny all;
    }
    
    location ~ /\.(git|env|config) {
        deny all;
    }

    # Error pages
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }

    # For letsencrypt
    location /.well-known/acme-challenge/ {
        alias /var/www/challenges/;
        try_files $uri =404;
    }
}
